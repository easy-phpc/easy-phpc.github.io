# Выборка данных

Назад: Добавление, редактирование и удаление данных • К началу: Документация • Далее: Работа с полями и индексами

Содержание
getLinesCount
getLinesFunction
getMinField
getMaxField
getField
getLine
isLinePresent
getLines
getLinesRange
getOrderedLines
getOrderedLinesRange
getDistinctField
getOrderedDistinctField
getCounters
getRandomLine
getRandomLines
Далее перечислены методы класса Database, предназначенные для поиска и выборки данных из таблиц. Рассмотрим их подробнее.

getLinesCount

int getLinesCount ( string table [, string conditions] )

Метод возвращает количество записей в таблице table, удовлетворяющих условиям conditions. В частности, если параметр conditions не указан или указана пустая строка, метод быстро определит общее количество записей в таблице.

Пример:

// Количество альбомов у группы Enigma
$band="Enigma";
$albumsCount=$database->getLinesCount("music","band=".slashes($band));
getLinesFunction

mixed getLinesFunction ( string table, string function [, string conditions] )

Метод возвращает результат работы агрегирующей функции над набором записей таблицы table, удовлетворяющих условиям conditions. В частности, если параметр conditions не указан или указана пустая строка, результат функции будет подсчитан для всех записей таблицы. Функция и ее аргумент указывается параметром function. Типичные агрегирующие функции − сумма (SUM), среднее значение (AVG), максимальное и минимальное значения (MAX и MIN). Для каждой из этих функций нужно также указать название поля, для которого выполняются математические операции, как показано в примере.

Пример:

// Наибольшее количество комментариев среди пользователей
$mostComments=$database->getLinesFunction("users","MAX(comments)");

// Общее количество комментариев у всех модераторов
$usergroupid=5;
$modsComments=$database->getLinesFunction("users","SUM(comments)","usergroupid=$usergroupid");

// Средняя цена товара в базе
$averagePrice=$database->getLinesFunction("products","AVG(price)");
getMinField

mixed getMinField ( string table, string field [, string conditions] )

Метод возвращает минимальное значение поля field среди записей таблицы table, удовлетворяющих условиям conditions. В частности, если параметр conditions не указан или указана пустая строка, метод возвращает минимальное значение поля field по всей таблице. Если условие conditions не подходит ни к одной записи таблицы, либо если таблица пуста, метод возвращает 0.

Пример:

// Стоимость самого дешевого товара
$cheapPrice=$database->getMinField("products","price");

// Стоимость самого дешевого товара от Canon
$brand="Canon";
$cheapPrice=$database->getMinField("products","price","brand=".slashes($brand));
getMaxField

mixed getMaxField ( string table, string field [, string conditions] )

Метод работает аналогично предыдущему, но возвращает максимальное значение поля вместо минимального.

Пример:

// Стоимость самого дорогого товара
$expensivePrice=$database->getMaxField("products","price");

// Стоимость самого дорогого товара от Canon
$brand="Canon";
$expensivePrice=$database->getMaxField("products","price","brand=".slashes($brand));
getField

mixed getField ( string table, string field [, string conditions] )

Метод возвращает значение поля field записи из таблицы table, удовлетворяющей условиям conditions. По сути, метод работает аналогично методу getLine, только он возвращает значение одного поля, а не всю запись целиком. Если вам не нужна вся запись, данный метод может быть удобнее.

Если таблица пуста, либо если ни одна запись в ней не удовлетворяет условиям conditions, метод возвращает false.

Пример:

// Название альбома группы Enigma, вышедшего в 2003
$album=$database->getField("music","album","band='Enigma' AND year=2003");
getLine

mixed getLine ( string table [, string conditions] )

Метод возвращает запись таблицы table, удовлетворяющую условиям conditions. Если этим условиям удовлетворяет две или более записей, метод вернет только одну из них (грубо говоря, ту, которая идет в таблице первой, но на это поведение не стоит рассчитывать). Если в таблице нет ни одной записи, подходящей под условия, либо если таблица пуста, метод возвращает false.

Данный метод, а также все последующие методы в этом разделе, возвращает запись в виде ассоциативного массива, в котором ключи являются названиями полей, а значения − данными записи.

Пример:

// Полная информация о пользователе с указанным ID
$userid=10;
$user=$database->getLine("users","id=$userid");
echo "Добро пожаловать, $user[username].";
isLinePresent

bool isLinePresent ( string table [, string conditions] )

Метод определяет, есть ли в таблице table хотя бы одна запись, удовлетворяющая условиям conditions, и возвращает true, если запись найдена, и false в противном случае. В частности, если параметр conditions не указан или указана пустая строка, метод определяет, есть ли вообще в таблице хотя бы одна запись.

Пример:

// Есть ли у группы Enigma хотя бы один альбом?
$band="Enigma";
$hasAlbum=$database->isLinePresent("music","band=".slashes($band));
getLines

array getLines ( string table [, string conditions] )

Метод возвращает все записи таблицы table, удовлетворяющие условиям conditions. В частности, если параметр conditions не указан или указана пустая строка, метод вернет все записи таблицы. Будьте осторожны, выбирать таблицу целиком рекомендуется только в том случае, если записей в ней не очень много. Если вам нужно только определить количество записей, но не нужны сами данные, используйте метод getLinesCount.

В качестве результата метод возвращает двухмерный массив (массив, состоящий из ассоциативных массивов), каждый элемент которого хранит данные об одной записи таблицы в формате "поле=>значение". Таким образом, сохранив результат работы метода в переменной, можно получить доступ к любой отдельной записи, или даже к любому значению поля. Это очень удобно.

Если в таблице не нашлось ни одной записи, удовлетворяющей условиям conditions, или если таблица пуста, метод возвращает пустой массив.

Примечание: данный метод возвращает записи в неотсортированном порядке. Можно считать, что записи будут перечислены в том порядке, в котором они идут в таблице, но рассчитывать на это поведение не стоит. Если вам нужна отсортированная выборка, используйте метод getOrderedLines.

Пример:

// Выбрать все альбомы всех групп, вышедшие после 2000
$albums=$database->getLines("music","year>=2000");

// Теперь можно пробежаться в цикле по полученному списку альбомов
foreach($albums as $album)
  foreach($album as $field=>$value) echo "$field=$value";

// Можно обращаться напрямую к данным любого альбома
$firstAlbum=$albums[0];
$firstAlbumYear=$firstAlbum["year"];
// Можно и еще проще
$firstAlbumYear=$albums[0]["year"];
getLinesRange

array getLinesRange ( string table, int offset, int count [, string conditions] )

Метод возвращает часть записей таблицы table, удовлетворяющих условиям conditions. В отличие от метода getLines, выбирающего все подходящие записи, данный метод возвращает лишь часть выборки, начиная с записи номер offset, и не более чем count записей. Например, если указать offset=10 и count=5, то первые 10 записей выборки будут пропущены, следующие 5 − возвращены, а все остальные − вновь пропущены. Таким образом, метод вернет только с 11-й по 15-ю записи, если считать с единицы.

Метод удобен для организации постраничной навигации по списку записей. Зная номер страницы и количество записей на каждой странице, можно легко вычислить значения offset и count, и выбрать только те записи, которые требуются для отображения на текущей странице. Это гораздо быстрее и экономичнее, чем выбирать все записи, и затем отбрасывать ненужные.

Кроме того, данный метод может быть полезен, если нужно наложить на выборку ограничение по размеру. Например, если вам нужно выбрать не более 20 записей, удовлетворяющих условию, укажите 0 в качестве значения offset, и 20 в качестве значения count, как в примере.

В случае, если записей, подходящих к условиям, недостаточно, чтобы набрать count штук, либо если вы указали слишком большое значение параметра offset, метод возвращает столько записей, сколько возможно. В частности, если в таблице не нашлось ни одной записи, удовлетворяющей условиям conditions, или если таблица пуста, метод возвращает пустой массив.

Примечание: данный метод возвращает записи в неотсортированном порядке. Можно считать, что записи будут перечислены в том порядке, в котором они идут в таблице, но рассчитывать на это поведение не стоит. Если вам нужна отсортированная выборка, используйте метод getOrderedLinesRange.

Пример:

// Номер страницы и количество альбомов на странице
$pageNum=3;
$pageSize=10;
// Расчет значения offset (count равен размеру страницы)
$offset=($pageNum-1)*$pageSize;
// Список альбомов для данной страницы
$albums=$database->getLinesRange("music",$offset,$pageSize);

// Выборка первых попавшихся пользователей без комментариев,
// но не более 20 пользователей за один раз
$unfortunateUsers=$database->getLinesRange("users",0,20,"comments=0");
getOrderedLines

array getOrderedLines ( string table, string order [, string conditions] )

Метод работает аналогично методу getLines, за одним важным исключением: перед тем, как возвращать найденные записи, он сортирует их согласно порядку, указанному параметром order. В качестве этого параметра можно указать либо название поля (в этом случае записи будут отсортированы по возрастанию значений этого поля), либо несколько полей через запятую (в этом случае записи будут сортироваться сначала по первому полю, если его значения совпадают − тогда по второму, и так далее). Можно указать сортировку по убыванию значений, в этом случае надо добавить DESC после названия поля, как в примере.

Сортировать можно не только по целочисленным полям, но и по строковым. В этом случае записи будут сортироваться по алфавиту, без учета регистра (если при создании поля не было указано обратное). Как и в случае метода getLines, не рекомендуется выбирать, и тем более сортировать, слишком большое количество записей.

Пример:

// Все альбомы группы Enigma, по алфавиту
$band="Enigma";
$albums=$database->getOrderedLines("music","album","band=".slashes($band));

// Все модераторы, по убыванию количества комментариев
$usergroupid=5;
$moderators=$database->getOrderedLines("users","comments DESC","usergroupid=$usergroupid");
getOrderedLinesRange

array getOrderedLinesRange ( string table, string order, int offset, int count [, string conditions] )

Данный метод является комбинацией методов getOrderedLines и getLinesRange: с одной стороны, он возвращает записи в отсортированном порядке, согласно параметру order (причем, что важно, сортирует записи до того, как определять границы диапазона выборки), с другой − он возвращает выборку не целиком, а только ее фрагмент, согласно параметрам offset и count.

Пример:

// Номер страницы и количество альбомов на странице
$pageNum=3;
$pageSize=10;
// Расчет значения offset (count равен размеру страницы)
$offset=($pageNum-1)*$pageSize;
// Список альбомов для данной страницы
// Альбомы сортируются по группе и по названию
$albums=$database->getOrderedLinesRange("music","band,album",$offset,$pageSize);

// 10 лучших пользователей (с наибольшим количеством комментариев)
$bestUsers=$database->getOrderedLinesRange("users","comments DESC",0,10);
getDistinctField

array getDistinctField ( string table, string field [, string conditions] )

Метод возвращает список уникальных значений поля field среди записей таблицы table, удовлетворяющих условиям conditions. В частности, если параметр conditions не указан или указана пустая строка, метод возвращает список уникальных значений поля по всей таблице. Результат − обычный одномерный массив со списком значений.

Метод возвращает данные в том порядке, в котором они следуют в таблице, никак не сортируя результат. Если вам нужен массив значений в упорядоченном виде, используйте метод getOrderedDistinctField.

Пример:

// Список всех музыкальных групп
$bands=$database->getDistinctField("music","band");

// Список всех брэндов, производящих фотоаппараты
$photoid=100;
$photoBrands=$database->getDistinctField("products","brand","kindid=$photoid");
getOrderedDistinctField

array getOrderedDistinctField ( string table, string field [, string conditions] )

Метод работает аналогично предыдущему, но возвращает результат в отсортированном виде.

Пример:

// Список всех музыкальных групп по алфавиту
$bands=$database->getOrderedDistinctField("music","band");

// Список всех брэндов (по алфавиту), производящих фотоаппараты
$photoid=100;
$photoBrands=$database->getOrderedDistinctField("products","brand","kindid=$photoid");
getCounters

array getCounters ( string table, string field [, string conditions] )

Зачастую разные записи таблицы имеют одно и то же значение некоторого поля. Например, разные альбомы имеют одно и то же название музыкальной группы, или различные товары имеют одного и того же производителя, или различные пользователи относятся к одной и той же группе. Иногда бывает полезно знать, сколько различных значений этого поля содержит таблица, а также сколько записей имеют то или иное значение поля. Например, сколько товаров в базе на данный момент у того или иного производителя.

Данный метод возвращает сводную статистику по полю field среди записей таблицы table, удовлетворяющих условиям conditions. Возвращается список всех различных значений поля field, и для каждого значения − количество записей, имеющих это значение поля. Результат имеет вид ассоциативного массива, у которого ключи − это уникальные значения поля, а значения − это целочисленные значения счетчика.

Если условие conditions не подходит ни к одной записи таблицы, либо если таблица пуста, метод возвращает пустой массив. Если же под указанные условия подходит хотя бы одна запись таблицы, массив будет содержать как минимум одну пару "значение-счетчик". Для каждой пары счетчик всегда является положительным целым числом, если какое-то значение поля отсутствует в таблице, оно просто не попадает в результат.

Если подсчитать количество элементов в возвращаемом массиве (например, при помощи стандартной функции count), вы получите количество уникальных значений поля field. Если просуммировать все счетчики массива (например, при помощи стандартной функции array_sum), вы получите общее количество записей, обработанных выборкой. Если поделить вторую величину на первую, вы получите средний размер группы, или усредненное количество записей с одинаковым значением поля.

Пример:

// Статистика товаров по производителям
$counters=$database->getCounters("products","brand");
// Выводим статистику
foreach($counters as $brand=>$counter) echo "$brand: $counter товаров.";
echo "Всего производителей: ".count($counters);
echo "Всего товаров: ".array_sum($counters);
getRandomLine

mixed getRandomLine ( string table [, string conditions] )

Метод возвращает случайную запись таблицы table, удовлетворяющую условиям conditions. В частности, если параметр conditions не указан или указана пустая строка, метод возвращает произвольную запись таблицы. Если в таблице нет ни одной записи, удовлетворяющей условиям, или если таблица пуста, метод возвращает false.

Пример:

// Случайный альбом
$randomAlbum=$database->getRandomLine("music");
getRandomLines

array getRandomLines ( string table [, int limit [, string conditions]] )

Метод возвращает записи таблицы table, удовлетворяющие условиям conditions, в случайном порядке. Количество возвращаемых записей определяется параметром limit: если он указан, метод вернет максимум limit записей, если параметр не указан или равен false − метод вернет все записи таблицы в перемешанном виде. Будьте осторожны, выбирать таблицу целиком рекомендуется только в том случае, если записей в ней не очень много.

В отличие от предыдущего метода, данный метод пользуется стандартной SQL-конструкцией ORDER BY RAND() для перемешивания данных. Если записей, удовлетворяющих условиям conditions, в таблице достаточно много, данный метод может работать медленно, независимо от того, выбираете вы таблицу целиком или только небольшое количество записей.

Пример:

// Пять случайных альбомов, в случайном порядке
$randomAlbums=$database->getRandomLines("music",5);

Назад: Добавление, редактирование и удаление данных • К началу: Документация • Далее: Работа с полями и индексами